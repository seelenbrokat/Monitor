<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zustellmonitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .overdue {
            background-color: #f8d7da !important;
            border-color: #f5c6cb !important;
        }
        .delivered {
            background-color: #d4edda !important;
            border-color: #c3e6cb !important;
        }
        .pending {
            background-color: #fff3cd !important;
            border-color: #ffeaa7 !important;
        }
        .status-badge {
            font-size: 0.8em;
            padding: 0.25em 0.5em;
        }
        .refresh-btn {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .stats-card {
            transition: transform 0.2s;
        }
        .stats-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row bg-primary text-white py-3 mb-4">
            <div class="col">
                <h1 class="mb-0">
                    <i class="fas fa-truck me-2"></i>
                    Zustellmonitor
                </h1>
                <small class="text-light">Überwachung von Sendungen und deren Zustellstatus</small>
            </div>
            <div class="col-auto d-flex align-items-center">
                <button id="refreshBtn" class="btn btn-outline-light me-2" onclick="refreshData()">
                    <i class="fas fa-sync-alt"></i> Aktualisieren
                </button>
                <span id="lastUpdate" class="text-light small"></span>
            </div>
        </div>

        <!-- Statistiken -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card bg-primary text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-boxes fa-2x mb-2"></i>
                        <h4 id="totalDeliveries">0</h4>
                        <small>Gesamt</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-warning text-dark">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <h4 id="pendingDeliveries">0</h4>
                        <small>Ausstehend</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h4 id="deliveredDeliveries">0</h4>
                        <small>Zugestellt</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card bg-danger text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <h4 id="overdueDeliveries">0</h4>
                        <small>Überfällig</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter und Sortierung -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="codeFilter" class="form-label">Code/SSCC</label>
                                <input type="text" class="form-control" id="codeFilter" placeholder="Code eingeben...">
                            </div>
                            <div class="col-md-4">
                                <label for="statusFilter" class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="">Alle Status</option>
                                    <option value="zugestellt">Zugestellt</option>
                                    <option value="ausstehend">Ausstehend</option>
                                    <option value="spät">Spät</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="locationFilter" class="form-label">Standort</label>
                                <input type="text" class="form-control" id="locationFilter" placeholder="Standort eingeben...">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <label for="sortBy" class="form-label">Sortieren nach</label>
                                <select class="form-select" id="sortBy">
                                    <option value="code">Code</option>
                                    <option value="statusText">Status</option>
                                    <option value="location1">Standort</option>
                                    <option value="createdAt">Erstellt</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="sortOrder" class="form-label">Reihenfolge</label>
                                <select class="form-select" id="sortOrder">
                                    <option value="asc">Aufsteigend</option>
                                    <option value="desc">Absteigend</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sendungen Tabelle -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>
                            Sendungen
                        </h5>
                        <span id="deliveryCount" class="badge bg-secondary">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Code/SSCC</th>
                                        <th>Status</th>
                                        <th>Standort</th>
                                        <th>Details</th>
                                        <th>Letzte Aktualisierung</th>
                                    </tr>
                                </thead>
                                <tbody id="deliveriesTable">
                                    <tr>
                                        <td colspan="5" class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Laden...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentData = [];
        let updateInterval;

        // Initial laden
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            setupAutoRefresh();
            setupFilters();
        });

        function setupAutoRefresh() {
            // Alle 10 Minuten aktualisieren
            updateInterval = setInterval(loadData, 10 * 60 * 1000);
        }

        function setupFilters() {
            // Filter-Event-Listener
            document.getElementById('codeFilter').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('locationFilter').addEventListener('input', applyFilters);
            document.getElementById('sortBy').addEventListener('change', applyFilters);
            document.getElementById('sortOrder').addEventListener('change', applyFilters);
        }

        function loadData() {
            const refreshBtn = document.getElementById('refreshBtn');
            refreshBtn.classList.add('refresh-btn');
            
            // Statistiken laden
            fetch('/api/stats')
                .then(response => response.json())
                .then(data => updateStats(data))
                .catch(error => console.error('Fehler beim Laden der Statistiken:', error));

            // Sendungen laden
            fetch('/api/deliveries')
                .then(response => response.json())
                .then(data => {
                    currentData = data.deliveries || [];
                    updateDeliveriesTable(currentData);
                    updateLastUpdate(data.last_update);
                    updateDeliveryCount(currentData.length);
                })
                .catch(error => {
                    console.error('Fehler beim Laden der Sendungen:', error);
                    document.getElementById('deliveriesTable').innerHTML = 
                        '<tr><td colspan="5" class="text-center text-danger">Fehler beim Laden der Daten</td></tr>';
                })
                .finally(() => {
                    refreshBtn.classList.remove('refresh-btn');
                });
        }

        function refreshData() {
            loadData();
        }

        function updateStats(stats) {
            document.getElementById('totalDeliveries').textContent = stats.total;
            document.getElementById('pendingDeliveries').textContent = stats.pending;
            document.getElementById('deliveredDeliveries').textContent = stats.delivered;
            document.getElementById('overdueDeliveries').textContent = stats.overdue;
        }

        function updateDeliveriesTable(deliveries) {
            const tbody = document.getElementById('deliveriesTable');
            
            if (deliveries.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">Keine Sendungen gefunden</td></tr>';
                return;
            }

            tbody.innerHTML = deliveries.map(delivery => {
                const statusClass = getStatusClass(delivery.statusText);
                const statusBadge = `<span class="badge ${statusClass} status-badge">${delivery.statusText || 'Unbekannt'}</span>`;
                
                return `
                    <tr class="${getRowClass(delivery.statusText)}">
                        <td><strong>${delivery.code || 'N/A'}</strong></td>
                        <td>${statusBadge}</td>
                        <td>${delivery.location1 || 'N/A'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="showDetails('${delivery.code}')">
                                <i class="fas fa-info-circle"></i> Details
                            </button>
                        </td>
                        <td>${formatDateTime(delivery.updatedAt || delivery.createdAt)}</td>
                    </tr>
                `;
            }).join('');
        }

        function getStatusClass(status) {
            if (!status) return 'bg-secondary';
            
            const statusLower = status.toLowerCase();
            if (statusLower.includes('zugestellt') || statusLower.includes('delivered') || statusLower.includes('completed')) {
                return 'bg-success';
            } else if (statusLower.includes('spät') || statusLower.includes('late') || statusLower.includes('overdue')) {
                return 'bg-danger';
            } else {
                return 'bg-warning';
            }
        }

        function getRowClass(status) {
            if (!status) return '';
            
            const statusLower = status.toLowerCase();
            if (statusLower.includes('spät') || statusLower.includes('late') || statusLower.includes('overdue')) {
                return 'overdue';
            } else if (statusLower.includes('zugestellt') || statusLower.includes('delivered') || statusLower.includes('completed')) {
                return 'delivered';
            } else {
                return 'pending';
            }
        }

        function applyFilters() {
            const codeFilter = document.getElementById('codeFilter').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
            const sortBy = document.getElementById('sortBy').value;
            const sortOrder = document.getElementById('sortOrder').value;

            let filteredData = currentData.filter(delivery => {
                const codeMatch = !codeFilter || (delivery.code && delivery.code.toLowerCase().includes(codeFilter));
                const statusMatch = !statusFilter || (delivery.statusText && delivery.statusText.toLowerCase().includes(statusFilter));
                const locationMatch = !locationFilter || (delivery.location1 && delivery.location1.toLowerCase().includes(locationFilter));
                
                return codeMatch && statusMatch && locationMatch;
            });

            // Sortierung anwenden
            if (sortBy) {
                filteredData.sort((a, b) => {
                    const aVal = a[sortBy] || '';
                    const bVal = b[sortBy] || '';
                    
                    if (sortOrder === 'desc') {
                        return String(bVal).localeCompare(String(aVal));
                    } else {
                        return String(aVal).localeCompare(String(bVal));
                    }
                });
            }

            updateDeliveriesTable(filteredData);
            updateDeliveryCount(filteredData.length);
        }

        function updateLastUpdate(timestamp) {
            if (timestamp) {
                const date = new Date(timestamp);
                document.getElementById('lastUpdate').textContent = 
                    `Letzte Aktualisierung: ${date.toLocaleString('de-DE')}`;
            }
        }

        function updateDeliveryCount(count) {
            document.getElementById('deliveryCount').textContent = count;
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            
            try {
                const date = new Date(timestamp);
                return date.toLocaleString('de-DE');
            } catch (e) {
                return timestamp;
            }
        }

        function showDetails(code) {
            const delivery = currentData.find(d => d.code === code);
            if (!delivery) return;

            const details = Object.entries(delivery)
                .map(([key, value]) => `<strong>${key}:</strong> ${value || 'N/A'}`)
                .join('<br>');

            // Einfacher Modal-Dialog
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Details für ${code}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            ${details}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', () => {
                document.body.removeChild(modal);
            });
        }
    </script>
</body>
</html>
